<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora Pro | La Esquina del Agricultor</title>
  
  <!-- Frameworks -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase SDK (Compat v8) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBGEiIKYV8MiA8lN3lteHaE1XkYD4GRxug",
      authDomain: "calculadora-esquina.firebaseapp.com",
      projectId: "calculadora-esquina",
      storageBucket: "calculadora-esquina.firebasestorage.app",
      messagingSenderId: "721368379664",
      appId: "1:721368379664:web:7dd83fad394c3d909b3595",
      measurementId: "G-MV6X87D4J3"
    };
    firebase.initializeApp(firebaseConfig);
    window.auth = firebase.auth();
    window.db   = firebase.firestore();
  </script>

  <style>
    .form-select {
      appearance: none; min-width: 200px; width: 100%;
      padding: 0.5rem 2.5rem 0.5rem 0.75rem;
      border: 1px solid #d1d5db; border-radius: .5rem;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right .75rem center; background-size: 1.25rem;
    }
    .tab-btn { border-bottom: 3px solid transparent; transition: all 0.3s; color: #6b7280; font-size: 0.875rem; font-weight: 600; }
    .tab-btn.active { border-color: #22c55e; color: #16a34a; }
    .input-field { border: 1px solid #d1d5db; border-radius: .5rem; padding: 0.5rem 0.75rem; width: 100%; }
    .animate-fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    #cloud-panel { position: fixed; right: 20px; bottom: 20px; z-index: 50; width: 300px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen pb-20 font-sans">
  <div class="mx-auto w-full max-w-6xl px-4 py-8">
    
    <header class="flex items-center justify-between pb-4 mb-6 border-b">
      <div>
        <h1 class="text-2xl font-extrabold text-green-700 flex items-center gap-2">
          <i data-lucide="leaf" class="text-green-500"></i> Calculadora La Esquina
        </h1>
        <p class="text-xs text-gray-500 font-medium">SISTEMA DINÁMICO DE PRECIOS</p>
      </div>
    </header>

    <nav class="flex gap-6 mb-8 border-b">
      <button onclick="switchTab('calc')" id="btnTabCalc" class="tab-btn active px-2 py-3 uppercase tracking-wider">Calculadora</button>
      <button onclick="switchTab('config')" id="btnTabConfig" class="tab-btn px-2 py-3 uppercase tracking-wider">Configuración</button>
    </nav>

    <!-- ======= VISTA CALCULADORA ======= -->
    <main id="viewCalc" class="grid lg:grid-cols-3 gap-8 animate-fade-in">
      <section class="lg:col-span-2 space-y-6">
        <div class="bg-white shadow-sm rounded-2xl p-6 border border-gray-100">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Categoría</label>
              <!-- SELECT DINÁMICO -->
              <select id="calcCategory" onchange="handleCategoryChange()" class="form-select mt-1 font-bold text-gray-700"></select>
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Costo Base</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-2 text-gray-400 font-bold">$</span>
                <input type="number" id="calcBaseCost" value="0.00" step="0.01" class="input-field pl-8 text-lg font-bold text-gray-800" oninput="runCalculations()">
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6 mt-6">
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Etiqueta IEPS</label>
              <select id="calcIeps" onchange="runCalculations()" class="form-select mt-1"></select>
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Producto Especial</label>
              <select id="calcOportunidad" onchange="runCalculations()" class="form-select mt-1"></select>
            </div>
          </div>

          <div class="mt-8 p-4 bg-green-50 rounded-xl space-y-4 border border-green-100">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="calcManualToggle" onchange="toggleManualMargin()" class="w-4 h-4 rounded text-green-600">
              <span class="text-sm font-bold text-green-800">MARGEN MANUAL</span>
            </label>
            <div id="manualMarginWrap" class="hidden animate-fade-in pl-7">
              <div class="flex items-center gap-3">
                <input type="number" id="calcManualMargin" value="20" class="input-field w-24 font-bold" oninput="runCalculations()">
                <span class="text-sm font-bold text-green-700">% Ganancia</span>
              </div>
            </div>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="calcIvaToggle" onchange="runCalculations()" class="w-4 h-4 rounded text-green-600">
              <span class="text-sm font-bold text-green-800 uppercase">Incluir IVA en costo</span>
            </label>
          </div>
        </div>

        <div class="bg-white shadow-sm rounded-2xl p-6 border border-gray-100">
          <div class="flex justify-between items-center mb-6">
            <h3 class="font-extrabold text-gray-800 flex items-center gap-2 italic text-sm uppercase">Escalas de Volumen</h3>
            <input type="text" id="calcScaleQty" value="1, 10, 50, 100" class="text-xs border rounded-lg px-3 py-1 w-40 font-bold text-green-700" oninput="runCalculations()">
          </div>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-gray-400 border-b uppercase text-[10px] text-left">
                <th class="pb-3">Cant.</th>
                <th class="pb-3">Unitario</th>
                <th class="pb-3 text-right">Margen %</th>
              </tr>
            </thead>
            <tbody id="scaleTableBody"></tbody>
          </table>
        </div>
      </section>

      <aside class="space-y-4">
        <div class="bg-green-600 rounded-3xl p-8 text-white shadow-xl">
          <p class="text-green-100 text-[10px] font-black uppercase tracking-widest">Precio Sugerido</p>
          <div id="resFinalPrice" class="text-5xl font-black mt-2 tracking-tighter">$0.00</div>
          <p id="resIvaNote" class="text-green-200 text-[10px] mt-4 font-bold uppercase"></p>
        </div>
        <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm space-y-5">
          <div class="flex justify-between items-end">
            <span class="text-gray-400 text-[10px] font-black uppercase">Margen Real</span>
            <span id="resMarginPct" class="font-black text-2xl text-gray-800">0%</span>
          </div>
          <div class="flex justify-between items-end">
            <span class="text-gray-400 text-[10px] font-black uppercase">Utilidad</span>
            <span id="resProfit" class="font-black text-2xl text-green-600">$0.00</span>
          </div>
        </div>
      </aside>
    </main>

    <!-- ======= VISTA CONFIGURACIÓN ======= -->
    <div id="viewConfig" class="hidden animate-fade-in space-y-10">
      
      <!-- GESTIÓN DE CATEGORÍAS -->
      <div class="bg-white rounded-2xl p-8 border shadow-sm">
        <h2 class="text-xl font-black text-gray-800 uppercase italic mb-6 flex items-center gap-2">
           <i data-lucide="folder-edit" class="text-green-600"></i> Gestión de Categorías
        </h2>
        <div id="categoryManager" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Se cargan aquí -->
        </div>
        <button onclick="addNewCategory()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase hover:bg-black transition">
          + Agregar Nueva Categoría
        </button>
      </div>

      <!-- EDITOR DE MÁRGENES -->
      <div class="bg-white rounded-2xl p-8 border shadow-sm">
        <div class="flex justify-between items-center mb-8">
          <div>
            <h2 class="text-xl font-black text-gray-800 uppercase italic tracking-tight">Editor de Márgenes Automáticos</h2>
          </div>
          <div class="flex gap-3">
            <button onclick="saveAllConfig()" class="bg-green-600 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 shadow-lg">
              <i data-lucide="save" class="w-4 h-4"></i> Guardar Todo
            </button>
            <button onclick="resetToDefaults()" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl font-bold border border-red-100">Restablecer</button>
          </div>
        </div>
        <div id="configContainer" class="grid md:grid-cols-2 gap-8"></div>
      </div>
    </div>
  </div>

  <div id="cloud-panel" class="p-5">
    <div class="flex items-center gap-2 mb-4 border-b pb-2">
      <div class="w-2.5 h-2.5 rounded-full bg-gray-300" id="auth-status-dot"></div>
      <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest" id="auth-status-text">Desconectado</span>
    </div>
    <div id="auth-form" class="space-y-3">
      <input type="email" id="fb-email" placeholder="Email" class="text-xs border w-full p-2.5 rounded-lg">
      <input type="password" id="fb-pass" placeholder="Password" class="text-xs border w-full p-2.5 rounded-lg">
      <button onclick="handleLogin()" class="w-full bg-blue-600 text-white text-xs py-2.5 rounded-lg font-black uppercase">ENTRAR</button>
    </div>
    <div id="cloud-actions" class="hidden space-y-3">
      <button onclick="syncToCloud()" class="w-full bg-green-600 text-white text-xs py-3 rounded-lg font-black uppercase flex justify-center gap-2 italic">
        <i data-lucide="upload-cloud" class="w-4 h-4"></i> Guardar Nube
      </button>
      <button onclick="pullFromCloud()" class="w-full bg-amber-500 text-white text-xs py-3 rounded-lg font-black uppercase flex justify-center gap-2 italic">
        <i data-lucide="download-cloud" class="w-4 h-4"></i> Bajar Nube
      </button>
      <button onclick="auth.signOut()" class="w-full text-red-500 text-[10px] font-black mt-4 uppercase">Cerrar Sesión</button>
    </div>
  </div>

  <script>
    const CONFIG = {
      IVA_RATE: 0.16,
      LS_KEY: 'esquina_agricola_v7',
      DEFAULT_CATEGORIES: ["Agroquimicos", "Granel", "KG-LT", "FERTILIZANTES", "INOCUIDAD", "MAQUINARIA"]
    };

    // Estado inicial
    let appState = {
      categories: [...CONFIG.DEFAULT_CATEGORIES],
      margins: {
        Agroquimicos: [{max: 400, m: 27}, {max: Infinity, m: 17}],
        Granel: [{max: Infinity, m: 40}],
        "KG-LT": [{max: Infinity, m: 20}],
        FERTILIZANTES: [{max: Infinity, m: 15}],
        INOCUIDAD: [{max: Infinity, m: 20}],
        MAQUINARIA: [{max: Infinity, m: 10}]
      },
      oportunidades: { Agroquimicos: [], Granel: [], "KG-LT": [], FERTILIZANTES: [], INOCUIDAD: [], MAQUINARIA: [] }
    };

    // --- GESTIÓN DINÁMICA DE CATEGORÍAS ---
    function renderCategoryManager() {
      const container = document.getElementById('categoryManager');
      container.innerHTML = '';
      appState.categories.forEach((cat, index) => {
        container.innerHTML += `
          <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border">
            <input type="text" value="${cat}" onchange="renameCategory(${index}, this.value)" 
              class="bg-transparent font-bold text-sm w-full outline-none focus:text-green-600">
            <button onclick="removeCategory(${index})" class="text-red-400 hover:text-red-600 p-1">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </div>
        `;
      });
      lucide.createIcons();
      updateCategoryDropdowns();
    }

    function addNewCategory() {
      const name = prompt("Nombre de la nueva categoría:");
      if (name && !appState.categories.includes(name)) {
        appState.categories.push(name);
        appState.margins[name] = [{max: Infinity, m: 20}];
        appState.oportunidades[name] = [];
        renderCategoryManager();
        renderConfigTables();
        saveLocal();
      }
    }

    function renameCategory(index, newName) {
      const oldName = appState.categories[index];
      if (newName && oldName !== newName) {
        appState.categories[index] = newName;
        // Mover los datos de margen y oportunidad a la nueva clave
        appState.margins[newName] = appState.margins[oldName];
        delete appState.margins[oldName];
        appState.oportunidades[newName] = appState.oportunidades[oldName];
        delete appState.oportunidades[oldName];
        
        updateCategoryDropdowns();
        renderConfigTables();
        saveLocal();
      }
    }

    function removeCategory(index) {
      if (confirm("¿Seguro? Se borrarán también sus márgenes configurados.")) {
        const name = appState.categories[index];
        appState.categories.splice(index, 1);
        delete appState.margins[name];
        delete appState.oportunidades[name];
        renderCategoryManager();
        renderConfigTables();
        saveLocal();
      }
    }

    function updateCategoryDropdowns() {
      const select = document.getElementById('calcCategory');
      const currentVal = select.value;
      select.innerHTML = '';
      appState.categories.forEach(cat => {
        select.innerHTML += `<option value="${cat}">${cat}</option>`;
      });
      if (appState.categories.includes(currentVal)) select.value = currentVal;
    }

    // --- MÁRGENES ---
    function renderConfigTables() {
      const container = document.getElementById('configContainer');
      container.innerHTML = '';
      appState.categories.forEach(cat => {
        let html = `
          <div class="border rounded-2xl p-6 bg-white shadow-sm border-gray-100">
            <h3 class="font-black text-green-700 mb-4 uppercase text-[10px] tracking-widest flex items-center gap-2 italic">
              <i data-lucide="tag" class="w-4 h-4"></i> ${cat}
            </h3>
            <div class="space-y-3 mb-4">`;
        
        (appState.margins[cat] || []).forEach((rule, idx) => {
          html += `
            <div class="flex items-center gap-2">
              <input type="number" value="${rule.max === Infinity ? '' : rule.max}" placeholder="Infinito"
                oninput="updateMarginRule('${cat}', ${idx}, 'max', this.value)"
                class="w-full p-2 border rounded-lg font-bold text-xs bg-gray-50">
              <input type="number" value="${rule.m}" oninput="updateMarginRule('${cat}', ${idx}, 'm', this.value)"
                class="w-full p-2 border rounded-lg font-bold text-xs text-green-600 bg-gray-50">
              <button onclick="removeMarginRow('${cat}', ${idx})" class="text-red-300 hover:text-red-500">
                <i data-lucide="x-circle" class="w-4 h-4"></i>
              </button>
            </div>`;
        });

        html += `</div>
            <button onclick="addMarginRow('${cat}')" class="w-full border-2 border-dashed border-gray-100 py-2 rounded-xl text-[9px] font-black text-gray-400 uppercase hover:text-green-500 transition-all">+ Añadir Rango</button>
          </div>`;
        container.innerHTML += html;
      });
      lucide.createIcons();
    }

    function addMarginRow(cat) { appState.margins[cat].push({max: 2000, m: 15}); renderConfigTables(); }
    function removeMarginRow(cat, idx) { appState.margins[cat].splice(idx, 1); renderConfigTables(); }
    function updateMarginRule(cat, idx, field, val) { appState.margins[cat][idx][field] = val === '' ? Infinity : parseFloat(val); }

    // --- CÁLCULOS ---
    function runCalculations() {
      const category = document.getElementById('calcCategory').value;
      const baseCost = parseFloat(document.getElementById('calcBaseCost').value) || 0;
      const iepsKey = document.getElementById('calcIeps').value;
      const opName = document.getElementById('calcOportunidad').value;
      const isManual = document.getElementById('calcManualToggle').checked;
      const includeIva = document.getElementById('calcIvaToggle').checked;

      const iepsAmt = baseCost * (CONFIG.IEPS[iepsKey] || 0);
      const ivaAmt = includeIva ? baseCost * CONFIG.IVA_RATE : 0;
      const totalCost = baseCost + iepsAmt + ivaAmt;

      let m = 0;
      if(isManual) m = parseFloat(document.getElementById('calcManualMargin').value) || 0;
      else if(opName) m = (appState.oportunidades[category]?.find(o => o.name === opName))?.m || 20;
      else {
        const rules = appState.margins[category] || [{max: Infinity, m: 20}];
        m = (rules.find(r => totalCost < r.max) || rules[rules.length-1]).m;
      }

      const finalPrice = totalCost / (1 - (Math.min(m/100, 0.99)));
      document.getElementById('resFinalPrice').textContent = fmt$(finalPrice);
      document.getElementById('resProfit').textContent = fmt$(finalPrice - totalCost);
      document.getElementById('resMarginPct').textContent = m.toFixed(1) + '%';
      updateScales(totalCost, finalPrice);
      saveLocal();
    }

    function updateScales(cost, basePVP) {
      const container = document.getElementById('scaleTableBody');
      const qtys = document.getElementById('calcScaleQty').value.split(',').map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
      container.innerHTML = '';
      qtys.forEach(q => {
        let disc = q >= 100 ? 8 : (q >= 50 ? 5 : (q >= 10 ? 3 : 0));
        let p = basePVP * (1 - disc/100);
        container.innerHTML += `<tr><td class="py-2 text-gray-400 font-bold">${q}</td><td class="font-black">${fmt$(p)}</td><td class="text-right text-gray-700">${p > 0 ? (((p - cost) / p) * 100).toFixed(1) : 0}%</td></tr>`;
      });
    }

    // --- GENERAL ---
    function switchTab(view) {
      document.getElementById('viewCalc').classList.toggle('hidden', view !== 'calc');
      document.getElementById('viewConfig').classList.toggle('hidden', view !== 'config');
      document.getElementById('btnTabCalc').classList.toggle('active', view === 'calc');
      document.getElementById('btnTabConfig').classList.toggle('active', view === 'config');
      if(view === 'config') { renderCategoryManager(); renderConfigTables(); }
    }

    const fmt$ = n => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n);
    function saveLocal() { localStorage.setItem(CONFIG.LS_KEY, JSON.stringify(appState)); }
    function saveAllConfig() { 
      for(let cat in appState.margins) appState.margins[cat].sort((a,b) => a.max - b.max);
      saveLocal(); alert("Guardado."); renderConfigTables(); runCalculations(); 
    }
    
    function toggleManualMargin() { document.getElementById('manualMarginWrap').classList.toggle('hidden'); runCalculations(); }
    function handleCategoryChange() {
      const cat = document.getElementById('calcCategory').value;
      const opSel = document.getElementById('calcOportunidad');
      opSel.innerHTML = '<option value="">— Ninguno —</option>';
      (appState.oportunidades[cat] || []).forEach(o => { opSel.innerHTML += `<option value="${o.name}">${o.name} (${o.m}%)</option>`; });
      runCalculations();
    }

    // --- FIREBASE ---
    auth.onAuthStateChanged(user => {
      const actions = document.getElementById('cloud-actions');
      const form = document.getElementById('auth-form');
      const dot = document.getElementById('auth-status-dot');
      if (user) {
        dot.className = "w-2.5 h-2.5 rounded-full bg-green-500 shadow-md";
        document.getElementById('auth-status-text').textContent = user.email;
        form.classList.add('hidden'); actions.classList.remove('hidden');
      } else {
        dot.className = "w-2.5 h-2.5 rounded-full bg-gray-300";
        document.getElementById('auth-status-text').textContent = "Offline";
        form.classList.remove('hidden'); actions.classList.add('hidden');
      }
    });

    async function handleLogin() {
      try { await auth.signInWithEmailAndPassword(document.getElementById('fb-email').value, document.getElementById('fb-pass').value); } 
      catch (e) { alert(e.message); }
    }
    async function syncToCloud() {
      try { await db.collection('configs').doc('global').set({ data: JSON.stringify(appState), updatedAt: new Date() }); alert("Nube OK"); }
      catch (e) { alert(e.message); }
    }
    async function pullFromCloud() {
      try {
        const doc = await db.collection('configs').doc('global').get();
        if(doc.exists) { appState = JSON.parse(doc.data().data); saveLocal(); renderCategoryManager(); handleCategoryChange(); alert("Bajado."); }
      } catch (e) { alert(e.message); }
    }

    window.onload = () => {
      const local = localStorage.getItem(CONFIG.LS_KEY);
      if(local) appState = JSON.parse(local);
      document.getElementById('calcIeps').innerHTML = `<option value="none">Sin IEPS</option><option value="azul">Azul (6%)</option><option value="amarilla">Amarilla (7%)</option><option value="roja">Roja (9%)</option>`;
      CONFIG.IEPS = { none:0, azul:0.06, amarilla:0.07, roja:0.09 };
      lucide.createIcons();
      updateCategoryDropdowns();
      handleCategoryChange();
    };
  </script>
</body>
</html>
