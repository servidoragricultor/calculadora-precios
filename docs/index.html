<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora Pro | La Esquina del Agricultor</title>
  
  <!-- Frameworks -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase SDK (Compat v8) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // CONFIGURACIÓN DE FIREBASE (Clave confirmada: ...GRxug)
    const firebaseConfig = {
      apiKey: "AIzaSyBGEiIKYV8MiA8lN3lteHaE1XkYD4GRxug",
      authDomain: "calculadora-esquina.firebaseapp.com",
      projectId: "calculadora-esquina",
      storageBucket: "calculadora-esquina.firebasestorage.app",
      messagingSenderId: "721368379664",
      appId: "1:721368379664:web:7dd83fad394c3d909b3595",
      measurementId: "G-MV6X87D4J3"
    };

    firebase.initializeApp(firebaseConfig);
    window.auth = firebase.auth();
    window.db   = firebase.firestore();
  </script>

  <style>
    .form-select {
      appearance: none; min-width: 200px; width: 100%;
      padding: 0.5rem 2.5rem 0.5rem 0.75rem;
      border: 1px solid #d1d5db; border-radius: .5rem;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right .75rem center; background-size: 1.25rem;
    }
    .tab-btn { border-bottom: 3px solid transparent; transition: all 0.3s; color: #6b7280; }
    .tab-btn.active { border-color: #22c55e; color: #16a34a; font-weight: bold; }
    .input-field { border: 1px solid #d1d5db; border-radius: .5rem; padding: .5rem .75rem; width: 100%; }
    .animate-fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    #cloud-panel { position: fixed; right: 20px; bottom: 20px; z-index: 50; width: 300px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen pb-20 font-sans">
  <div class="mx-auto w-full max-w-6xl px-4 py-8">
    
    <!-- Header -->
    <header class="flex items-center justify-between pb-4 mb-6 border-b">
      <div>
        <h1 class="text-2xl font-extrabold text-green-700 flex items-center gap-2">
          <i data-lucide="leaf" class="text-green-500"></i> Calculadora La Esquina
        </h1>
        <p class="text-xs text-gray-500 font-medium">SISTEMA DE PRECIOS Y MÁRGENES</p>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="flex gap-6 mb-8 border-b">
      <button onclick="switchTab('calc')" id="btnTabCalc" class="tab-btn active px-2 py-3 text-sm uppercase tracking-wider">Calculadora</button>
      <button onclick="switchTab('config')" id="btnTabConfig" class="tab-btn px-2 py-3 text-sm uppercase tracking-wider">Configuración de Márgenes</button>
    </nav>

    <!-- ======= VISTA CALCULADORA ======= -->
    <main id="viewCalc" class="grid lg:grid-cols-3 gap-8">
      <section class="lg:col-span-2 space-y-6">
        <div class="bg-white shadow-sm rounded-2xl p-6 border border-gray-100">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Categoría de Producto</label>
              <select id="calcCategory" onchange="handleCategoryChange()" class="form-select mt-1">
                <option value="Agroquimicos">Agroquímicos</option>
                <option value="Granel">Granel</option>
                <option value="KG-LT">Kg-Lt</option>
                <option value="FERTILIZANTES">Fertilizantes</option>
                <option value="INOCUIDAD">Inocuidad</option>
                <option value="MAQUINARIA">Maquinaria</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Costo Base (Sin IVA)</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-2 text-gray-400 font-bold">$</span>
                <input type="number" id="calcBaseCost" value="0.00" step="0.01" class="input-field pl-8 text-lg font-bold text-gray-800" oninput="runCalculations()">
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6 mt-6">
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Impuesto IEPS</label>
              <select id="calcIeps" onchange="runCalculations()" class="form-select mt-1"></select>
            </div>
            <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Producto Especial (Oportunidad)</label>
              <select id="calcOportunidad" onchange="runCalculations()" class="form-select mt-1"></select>
            </div>
          </div>

          <div class="mt-8 p-4 bg-green-50 rounded-xl space-y-4 border border-green-100">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="calcManualToggle" onchange="toggleManualMargin()" class="w-4 h-4 rounded text-green-600 focus:ring-green-500">
              <span class="text-sm font-bold text-green-800">EDITAR MARGEN MANUALMENTE</span>
            </label>
            <div id="manualMarginWrap" class="hidden animate-fade-in pl-7">
              <div class="flex items-center gap-3">
                <input type="number" id="calcManualMargin" value="20" class="input-field w-24 font-bold" oninput="runCalculations()">
                <span class="text-sm font-bold text-green-700">% de Ganancia</span>
              </div>
            </div>
            <label class="flex items-center gap-3 cursor-pointer pl-0">
              <input type="checkbox" id="calcIvaToggle" onchange="runCalculations()" class="w-4 h-4 rounded text-green-600 focus:ring-green-500">
              <span class="text-sm font-bold text-green-800">INCLUIR IVA EN COSTO (16%)</span>
            </label>
          </div>
        </div>

        <!-- Tabla Escalas -->
        <div class="bg-white shadow-sm rounded-2xl p-6 border border-gray-100">
          <div class="flex justify-between items-center mb-6">
            <h3 class="font-extrabold text-gray-800 flex items-center gap-2 italic">
              <i data-lucide="layers" class="w-5 h-5 text-green-600"></i> ESCALAS DE VOLUMEN
            </h3>
            <div class="flex items-center gap-2">
              <span class="text-[10px] font-bold text-gray-400">PIEZAS:</span>
              <input type="text" id="calcScaleQty" value="1, 10, 50, 100" class="text-xs border rounded-lg px-3 py-1 w-40 font-bold text-green-700" oninput="runCalculations()">
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-400 border-b uppercase text-[10px] tracking-widest">
                  <th class="pb-3 text-left">Cant.</th>
                  <th class="pb-3 text-left">P. Unitario</th>
                  <th class="pb-3 text-left">Venta Total</th>
                  <th class="pb-3 text-left">Utilidad</th>
                  <th class="pb-3 text-right">Margen</th>
                </tr>
              </thead>
              <tbody id="scaleTableBody" class="divide-y divide-gray-50 font-medium"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Sidebar Resumen -->
      <aside class="space-y-4">
        <div class="bg-green-600 rounded-3xl p-8 text-white shadow-xl shadow-green-100 relative overflow-hidden">
          <i data-lucide="trending-up" class="absolute -right-4 -bottom-4 w-32 h-32 opacity-10"></i>
          <p class="text-green-100 text-[10px] font-black uppercase tracking-widest">Precio Sugerido de Venta</p>
          <div id="resFinalPrice" class="text-5xl font-black mt-2 tracking-tighter">$0.00</div>
          <p id="resIvaNote" class="text-green-200 text-[10px] mt-4 font-bold uppercase"></p>
        </div>

        <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm space-y-5">
          <div class="flex justify-between items-end">
            <span class="text-gray-400 text-[10px] font-black uppercase">Margen Real</span>
            <span id="resMarginPct" class="font-black text-2xl text-gray-800 leading-none">0%</span>
          </div>
          <div class="flex justify-between items-end">
            <span class="text-gray-400 text-[10px] font-black uppercase">Utilidad Neta</span>
            <span id="resProfit" class="font-black text-2xl text-green-600 leading-none">$0.00</span>
          </div>
          <div class="pt-4 border-t space-y-3">
            <div class="flex justify-between text-[11px] font-bold">
              <span class="text-gray-400">COSTO BASE</span><span id="resBaseCost" class="text-gray-600">$0.00</span>
            </div>
            <div class="flex justify-between text-[11px] font-bold">
              <span class="text-gray-400">IEPS APLICADO</span><span id="resIeps" class="text-gray-600">$0.00</span>
            </div>
            <div class="flex justify-between text-[11px] font-bold">
              <span class="text-gray-400">IVA S/ COSTO</span><span id="resIva" class="text-gray-600">$0.00</span>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <!-- ======= VISTA CONFIGURACIÓN ======= -->
    <div id="viewConfig" class="hidden animate-fade-in space-y-6">
      <div class="bg-white rounded-2xl p-8 border shadow-sm">
        <div class="flex justify-between items-center mb-8">
          <div>
            <h2 class="text-2xl font-black text-gray-800 uppercase tracking-tight">Editor de Márgenes Automáticos</h2>
            <p class="text-sm text-gray-500">Define cuánto quieres ganar según el costo del producto por cada categoría.</p>
          </div>
          <div class="flex gap-3">
            <button onclick="saveAllConfig()" class="bg-green-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:bg-green-700 transition flex items-center gap-2">
              <i data-lucide="save" class="w-4 h-4"></i> Guardar Cambios
            </button>
            <button onclick="resetToDefaults()" class="bg-red-50 text-red-600 px-6 py-2 rounded-xl font-bold border border-red-100">Restablecer Todo</button>
          </div>
        </div>
        
        <div id="configContainer" class="grid md:grid-cols-2 gap-8">
          <!-- Las tablas de edición se generan aquí con JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Panel Firebase Flotante -->
  <div id="cloud-panel" class="p-5">
    <div class="flex items-center gap-2 mb-4 border-b pb-2">
      <div class="w-2.5 h-2.5 rounded-full bg-gray-300" id="auth-status-dot"></div>
      <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest" id="auth-status-text">Sin conexión</span>
    </div>
    <div id="auth-form" class="space-y-3">
      <input type="email" id="fb-email" placeholder="Correo electrónico" class="text-xs border w-full p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
      <input type="password" id="fb-pass" placeholder="Contraseña" class="text-xs border w-full p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
      <button onclick="handleLogin()" class="w-full bg-blue-600 text-white text-xs py-2.5 rounded-lg font-black uppercase tracking-widest shadow-lg shadow-blue-100">Iniciar Sesión</button>
    </div>
    <div id="cloud-actions" class="hidden space-y-3">
      <button onclick="syncToCloud()" class="w-full bg-green-600 text-white text-xs py-3 rounded-lg flex items-center justify-center gap-2 font-black uppercase tracking-widest shadow-lg shadow-green-100">
        <i data-lucide="upload-cloud" class="w-4 h-4"></i> Guardar en Nube
      </button>
      <button onclick="pullFromCloud()" class="w-full bg-amber-500 text-white text-xs py-3 rounded-lg flex items-center justify-center gap-2 font-black uppercase tracking-widest shadow-lg shadow-amber-100">
        <i data-lucide="download-cloud" class="w-4 h-4"></i> Cargar de Nube
      </button>
      <button onclick="auth.signOut()" class="w-full text-red-500 text-[10px] font-black uppercase tracking-widest mt-4 hover:underline">Cerrar Sesión</button>
    </div>
  </div>

  <script>
    // --- DATOS INICIALES ---
    const CONFIG = {
      IVA_RATE: 0.16,
      LS_KEY: 'esquina_agricola_v4',
      DEFAULT_MARGINS: {
        Agroquimicos: [ {max: 400, m: 27}, {max: 1000, m: 22}, {max: Infinity, m: 17} ],
        Granel: [ {max: 10, m: 50}, {max: Infinity, m: 40} ],
        "KG-LT": [ {max: 400, m: 27}, {max: Infinity, m: 17} ],
        FERTILIZANTES: [ {max: 500, m: 25}, {max: Infinity, m: 15} ],
        INOCUIDAD: [ {max: Infinity, m: 20} ],
        MAQUINARIA: [ {max: Infinity, m: 15} ]
      },
      OPORTUNIDADES: {
        Agroquimicos: [{ name: "Herbicida Premium", m: 35 }, { name: "Fungicida Especial", m: 40 }],
        Granel: [{ name: "Semilla Especial", m: 60 }],
        "KG-LT": [], "FERTILIZANTES": [], "INOCUIDAD": [], "MAQUINARIA": []
      },
      IEPS: { 'none': 0, 'azul': 0.06, 'amarilla': 0.07, 'roja': 0.09 }
    };

    let appState = {
      margins: JSON.parse(JSON.stringify(CONFIG.DEFAULT_MARGINS)),
      oportunidades: JSON.parse(JSON.stringify(CONFIG.OPORTUNIDADES))
    };

    // --- LÓGICA DE CÁLCULO ---
    function runCalculations() {
      const category = document.getElementById('calcCategory').value;
      const baseCost = parseFloat(document.getElementById('calcBaseCost').value) || 0;
      const iepsKey = document.getElementById('calcIeps').value;
      const opName = document.getElementById('calcOportunidad').value;
      const isManual = document.getElementById('calcManualToggle').checked;
      const includeIva = document.getElementById('calcIvaToggle').checked;

      const iepsRate = CONFIG.IEPS[iepsKey] || 0;
      const iepsAmt = baseCost * iepsRate;
      const ivaAmt = includeIva ? baseCost * CONFIG.IVA_RATE : 0;
      const totalCost = baseCost + iepsAmt + ivaAmt;

      let marginPct = 0;
      if(isManual) {
        marginPct = parseFloat(document.getElementById('calcManualMargin').value) || 0;
      } else if (opName) {
        const op = appState.oportunidades[category]?.find(o => o.name === opName);
        marginPct = op ? op.m : 20;
      } else {
        const rules = appState.margins[category];
        const rule = rules.find(r => totalCost < r.max) || rules[rules.length-1];
        marginPct = rule.m;
      }

      const ratio = Math.min(marginPct / 100, 0.99);
      const finalPrice = totalCost / (1 - ratio);
      const profit = finalPrice - totalCost;

      updateMainUI({ finalPrice, profit, marginPct, totalCost, baseCost, iepsAmt, ivaAmt, includeIva });
      updateScales(totalCost, finalPrice);
      saveLocal(); 
    }

    function updateMainUI(d) {
      document.getElementById('resFinalPrice').textContent = fmt$(d.finalPrice);
      document.getElementById('resProfit').textContent = fmt$(d.profit);
      document.getElementById('resMarginPct').textContent = d.marginPct.toFixed(1) + '%';
      document.getElementById('resBaseCost').textContent = fmt$(d.baseCost);
      document.getElementById('resIeps').textContent = fmt$(d.iepsAmt);
      document.getElementById('resIva').textContent = fmt$(d.ivaAmt);
      document.getElementById('resIvaNote').textContent = d.includeIva ? "IVA INCLUIDO EN COSTO" : "SIN IVA EN COSTO";
    }

    function updateScales(cost, basePVP) {
      const container = document.getElementById('scaleTableBody');
      const qtys = document.getElementById('calcScaleQty').value.split(',').map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
      container.innerHTML = '';
      qtys.forEach(q => {
        let disc = q >= 100 ? 8 : (q >= 50 ? 5 : (q >= 10 ? 3 : 0));
        let unitP = basePVP * (1 - disc/100);
        let profit = (unitP - cost) * q;
        let margin = unitP > 0 ? ((unitP - cost) / unitP) * 100 : 0;
        container.innerHTML += `
          <tr class="hover:bg-gray-50 transition">
            <td class="py-4 text-gray-400 font-bold">${q}</td>
            <td class="py-4 font-black text-gray-800">${fmt$(unitP)}</td>
            <td class="py-4 text-gray-600">${fmt$(unitP * q)}</td>
            <td class="py-4 text-green-600 font-bold">${fmt$(profit)}</td>
            <td class="py-4 text-right font-black text-gray-700">${margin.toFixed(1)}%</td>
          </tr>`;
      });
    }

    // --- LÓGICA DE CONFIGURACIÓN ---
    function renderConfigTables() {
      const container = document.getElementById('configContainer');
      container.innerHTML = '';
      for (const cat in appState.margins) {
        let html = `
          <div class="border rounded-2xl p-5 bg-gray-50 border-gray-100 shadow-sm">
            <h3 class="font-black text-green-700 mb-4 uppercase text-xs tracking-widest flex items-center gap-2">
              <i data-lucide="tag" class="w-3 h-3"></i> ${cat}
            </h3>
            <table class="w-full text-xs">
              <thead>
                <tr class="text-gray-400 text-left uppercase text-[9px] font-black">
                  <th class="pb-3">Costo hasta ($)</th>
                  <th class="pb-3">Ganancia (%)</th>
                </tr>
              </thead>
              <tbody class="space-y-2">`;
        appState.margins[cat].forEach((rule, index) => {
          html += `
            <tr>
              <td class="pr-3 pb-2">
                <input type="number" value="${rule.max === Infinity ? '' : rule.max}" 
                  placeholder="Infinito"
                  onchange="updateMarginRule('${cat}', ${index}, 'max', this.value)"
                  class="w-full p-2 border rounded-lg font-bold">
              </td>
              <td class="pb-2">
                <input type="number" value="${rule.m}" 
                  onchange="updateMarginRule('${cat}', ${index}, 'm', this.value)"
                  class="w-full p-2 border rounded-lg font-bold text-green-600">
              </td>
            </tr>`;
        });
        html += `</tbody></table></div>`;
        container.innerHTML += html;
      }
      lucide.createIcons();
    }

    function updateMarginRule(cat, index, field, value) {
      let val = value === '' ? Infinity : parseFloat(value);
      appState.margins[cat][index][field] = val;
    }

    function saveAllConfig() {
      saveLocal();
      runCalculations();
      alert("¡Configuración guardada en este navegador!");
    }

    // --- FIREBASE & TABS ---
    function switchTab(view) {
      document.getElementById('viewCalc').classList.toggle('hidden', view !== 'calc');
      document.getElementById('viewConfig').classList.toggle('hidden', view !== 'config');
      document.getElementById('btnTabCalc').classList.toggle('active', view === 'calc');
      document.getElementById('btnTabConfig').classList.toggle('active', view === 'config');
      if(view === 'config') renderConfigTables();
    }

    auth.onAuthStateChanged(user => {
      const dot = document.getElementById('auth-status-dot');
      const text = document.getElementById('auth-status-text');
      const form = document.getElementById('auth-form');
      const actions = document.getElementById('cloud-actions');
      if (user) {
        dot.className = "w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]";
        text.textContent = "Conectado: " + user.email;
        form.classList.add('hidden');
        actions.classList.remove('hidden');
      } else {
        dot.className = "w-2.5 h-2.5 rounded-full bg-gray-300";
        text.textContent = "Sin conexión a nube";
        form.classList.remove('hidden');
        actions.classList.add('hidden');
      }
    });

    async function handleLogin() {
      const email = document.getElementById('fb-email').value;
      const pass = document.getElementById('fb-pass').value;
      try { await auth.signInWithEmailAndPassword(email, pass); } catch (e) { alert("Error: " + e.message); }
    }

    async function syncToCloud() {
      if(!auth.currentUser) return;
      try {
        await db.collection('configs').doc('global').set({ data: JSON.stringify(appState), updatedAt: new Date() });
        alert("¡Datos guardados en la nube con éxito!");
      } catch (e) { alert(e.message); }
    }

    async function pullFromCloud() {
      if(!auth.currentUser) return;
      try {
        const doc = await db.collection('configs').doc('global').get();
        if(doc.exists) {
          appState = JSON.parse(doc.data().data);
          saveLocal();
          handleCategoryChange();
          alert("Configuración descargada de la nube.");
        }
      } catch (e) { alert(e.message); }
    }

    // --- UTILIDADES ---
    const fmt$ = n => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n);
    function toggleManualMargin() { document.getElementById('manualMarginWrap').classList.toggle('hidden'); runCalculations(); }
    function saveLocal() { localStorage.setItem(CONFIG.LS_KEY, JSON.stringify(appState)); }
    function handleCategoryChange() {
      const cat = document.getElementById('calcCategory').value;
      const opSel = document.getElementById('calcOportunidad');
      opSel.innerHTML = '<option value="">— Ninguno —</option>';
      (appState.oportunidades[cat] || []).forEach(o => { opSel.innerHTML += `<option value="${o.name}">${o.name} (${o.m}%)</option>`; });
      runCalculations();
    }
    function resetToDefaults() {
      if(confirm("¿Quieres borrar todos tus cambios y volver a los valores originales?")) {
        appState = { margins: JSON.parse(JSON.stringify(CONFIG.DEFAULT_MARGINS)), oportunidades: JSON.parse(JSON.stringify(CONFIG.OPORTUNIDADES)) };
        saveLocal(); location.reload();
      }
    }

    window.onload = () => {
      const local = localStorage.getItem(CONFIG.LS_KEY);
      if(local) appState = JSON.parse(local);
      document.getElementById('calcIeps').innerHTML = `<option value="none">Sin IEPS (0%)</option><option value="azul" style="color:#2563eb">Etiqueta Azul (6%)</option><option value="amarilla" style="color:#d97706">Etiqueta Amarilla (7%)</option><option value="roja" style="color:#dc2626">Etiqueta Roja (9%)</option>`;
      lucide.createIcons();
      handleCategoryChange();
    };
  </script>
</body>
</html>
