<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Precios y Márgenes | La Esquina</title>
  
  <!-- Frameworks -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // CONFIGURACIÓN ÚNICA DE FIREBASE (Datos de tu imagen)
    const firebaseConfig = {
      apiKey: "AIzaSyBGEiIKYV8MiA8lN3LteHaE1XkYD4GRxug",
      authDomain: "calculadora-esquina.firebaseapp.com",
      projectId: "calculadora-esquina",
      storageBucket: "calculadora-esquina.firebasestorage.app",
      messagingSenderId: "721368379664",
      appId: "1:721368379664:web:7dd83fad394c3d909b3595",
      measurementId: "G-MV6X87D4J3"
    };

    firebase.initializeApp(firebaseConfig);
    window.auth = firebase.auth();
    window.db   = firebase.firestore();
  </script>

  <style>
    .form-select {
      appearance: none; min-width: 240px; width: 100%;
      padding: 0.5rem 2.75rem 0.5rem 0.75rem;
      border: 1px solid #d1d5db; border-radius: .5rem;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right .75rem center; background-size: 1.25rem;
      text-transform: capitalize;
    }
    .tab-btn { border-bottom: 2px solid transparent; transition: all 0.3s; }
    .tab-btn.active { border-color: #22c55e; color: #16a34a; font-weight: bold; }
    .input-field { border: 1px solid #d1d5db; border-radius: .5rem; padding: .5rem .75rem; width: 100%; }
    
    /* Animación */
    .animate-fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

    #cloud-panel {
      position: fixed; right: 20px; bottom: 20px; z-index: 50;
      width: 300px; background: white; border-radius: 12px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen pb-20">
  <div class="mx-auto w-full max-w-6xl px-4 py-8">
    
    <header class="flex items-center justify-between pb-4 mb-6 border-b">
      <div>
        <h1 class="text-2xl font-extrabold text-green-700 flex items-center gap-2">
          <i data-lucide="leaf" class="text-green-500"></i>
          Calculadora de Precios
        </h1>
        <p class="text-sm text-gray-500">La Esquina del Agricultor</p>
      </div>
    </header>

    <nav class="flex gap-4 mb-6">
      <button onclick="switchTab('calc')" id="btnTabCalc" class="tab-btn active px-4 py-2">Calculadora</button>
      <button onclick="switchTab('config')" id="btnTabConfig" class="tab-btn px-4 py-2">Configuración</button>
    </nav>

    <main id="viewCalc" class="grid lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 space-y-6">
        <div class="bg-white shadow-sm rounded-2xl p-6 border border-gray-100">
          <div class="grid md:grid-cols-2 gap-6">
            <div class="space-y-1">
              <label class="text-sm font-medium text-gray-600">Categoría</label>
              <select id="calcCategory" onchange="handleCategoryChange()" class="form-select">
                <option value="Agroquimicos">Agroquímicos</option>
                <option value="Granel">Granel</option>
                <option value="KG-LT">Kg-Lt</option>
                <option value="FERTILIZANTES">Fertilizantes</option>
                <option value="INOCUIDAD">Inocuidad</option>
                <option value="MAQUINARIA">Maquinaria</option>
              </select>
            </div>

            <div class="space-y-1">
              <label class="text-sm font-medium text-gray-600">Costo Base (Sin IVA)</label>
              <div class="relative">
                <span class="absolute left-3 top-2 text-gray-400">$</span>
                <input type="number" id="calcBaseCost" value="0.00" step="0.01" 
                  class="input-field pl-8 text-lg font-bold text-gray-800" oninput="runCalculations()">
              </div>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6 mt-4">
            <div class="space-y-1">
              <label class="text-sm font-medium text-gray-600">Tipo de Etiqueta (IEPS)</label>
              <select id="calcIeps" onchange="runCalculations()" class="form-select"></select>
            </div>
            <div class="space-y-1">
              <label class="text-sm font-medium text-gray-600">Producto Especial</label>
              <select id="calcOportunidad" onchange="runCalculations()" class="form-select">
                <option value="">— Ninguno —</option>
              </select>
            </div>
          </div>

          <div class="mt-6 p-4 bg-gray-50 rounded-xl space-y-3">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="calcManualToggle" onchange="toggleManualMargin()" class="rounded text-green-600">
              <span class="text-sm font-medium text-gray-700">Editar margen manualmente</span>
            </label>
            
            <div id="manualMarginWrap" class="hidden animate-fade-in">
              <label class="text-xs font-bold text-gray-500 uppercase">Margen Manual %</label>
              <input type="number" id="calcManualMargin" value="20" class="input-field mt-1" oninput="runCalculations()">
            </div>

            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="calcIvaToggle" onchange="runCalculations()" class="rounded text-green-600">
              <span class="text-sm font-medium text-gray-700">Incluir IVA en costo (16%)</span>
            </label>
          </div>
        </div>

        <div class="bg-white shadow-sm rounded-2xl p-6 border border-gray-100">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-gray-800">Escalas de Volumen</h3>
            <input type="text" id="calcScaleQty" value="1, 10, 50, 100" class="text-xs border rounded px-2 py-1 w-32" oninput="runCalculations()">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="text-gray-400 border-b">
                <tr>
                  <th class="pb-2">Cant.</th>
                  <th class="pb-2">P. Unit</th>
                  <th class="pb-2">Total</th>
                  <th class="pb-2">Ganancia</th>
                  <th class="pb-2 text-right">Margen</th>
                </tr>
              </thead>
              <tbody id="scaleTableBody" class="divide-y divide-gray-50"></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside class="space-y-4">
        <div class="bg-green-600 rounded-2xl p-6 text-white shadow-lg shadow-green-200">
          <p class="text-green-100 text-xs font-bold uppercase tracking-wider">Precio de Venta Final</p>
          <div id="resFinalPrice" class="text-4xl font-black mt-1">$0.00</div>
          <p id="resIvaNote" class="text-green-200 text-[10px] mt-2 italic"></p>
        </div>

        <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm space-y-4">
          <div class="flex justify-between items-center">
            <span class="text-gray-500 text-sm">Margen Bruto</span>
            <span id="resMarginPct" class="font-bold text-lg text-gray-800">0%</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500 text-sm">Utilidad</span>
            <span id="resProfit" class="font-bold text-green-600 text-lg">$0.00</span>
          </div>
          <hr>
          <div class="space-y-2 text-xs">
            <div class="flex justify-between text-gray-400"><span>Costo Base</span><span id="resBaseCost">$0.00</span></div>
            <div class="flex justify-between text-gray-400"><span>IEPS</span><span id="resIeps">$0.00</span></div>
            <div class="flex justify-between text-gray-400"><span>IVA s/ costo</span><span id="resIva">$0.00</span></div>
          </div>
        </div>
      </aside>
    </main>

    <div id="viewConfig" class="hidden bg-white rounded-2xl p-8 border shadow-sm">
      <h2 class="text-xl font-bold mb-6">Configuración Avanzada</h2>
      <p class="text-gray-500 mb-4">Los cambios se guardan localmente hasta que los subas a la nube.</p>
      <button onclick="resetToDefaults()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm font-bold border border-red-100">Restablecer Valores</button>
    </div>
  </div>

  <!-- Panel Firebase -->
  <div id="cloud-panel" class="p-4 hidden md:block">
    <div class="flex items-center gap-2 mb-3">
      <div class="w-2 h-2 rounded-full bg-gray-300" id="auth-status-dot"></div>
      <span class="text-xs font-bold text-gray-700" id="auth-status-text">Sin conexión</span>
    </div>
    <div id="auth-form" class="space-y-2">
      <input type="email" id="fb-email" placeholder="Email" class="text-xs border w-full p-2 rounded">
      <input type="password" id="fb-pass" placeholder="Password" class="text-xs border w-full p-2 rounded">
      <button onclick="handleLogin()" class="w-full bg-blue-600 text-white text-xs py-2 rounded font-bold">Entrar</button>
    </div>
    <div id="cloud-actions" class="hidden space-y-2">
      <button onclick="syncToCloud()" class="w-full bg-green-600 text-white text-xs py-2 rounded flex items-center justify-center gap-2">Subir a Nube</button>
      <button onclick="pullFromCloud()" class="w-full bg-amber-500 text-white text-xs py-2 rounded flex items-center justify-center gap-2">Bajar de Nube</button>
      <button onclick="auth.signOut()" class="w-full text-red-500 text-[10px] uppercase font-bold mt-2">Salir</button>
    </div>
  </div>

  <script>
    const CONFIG = {
      IVA_RATE: 0.16,
      LS_KEY: 'esquina_agricola_v4',
      DEFAULT_MARGINS: {
        Agroquimicos: [ {max: 400, m: 27}, {max: 1000, m: 22}, {max: Infinity, m: 17} ],
        Granel: [ {max: 10, m: 50}, {max: Infinity, m: 40} ],
        "KG-LT": [ {max: 400, m: 27}, {max: Infinity, m: 17} ],
        FERTILIZANTES: [ {max: 500, m: 25}, {max: Infinity, m: 15} ],
        INOCUIDAD: [ {max: Infinity, m: 20} ],
        MAQUINARIA: [ {max: Infinity, m: 15} ]
      },
      // Datos para "Producto Especial" (Oportunidad)
      OPORTUNIDADES: {
        Agroquimicos: [{ name: "Herbicida Premium", m: 35 }, { name: "Fungicida Especial", m: 40 }],
        Granel: [{ name: "Semilla a granel", m: 60 }]
      },
      IEPS: { 'none': 0, 'azul': 0.06, 'amarilla': 0.07, 'roja': 0.09 }
    };

    let appState = {
      margins: JSON.parse(JSON.stringify(CONFIG.DEFAULT_MARGINS)),
      oportunidades: JSON.parse(JSON.stringify(CONFIG.OPORTUNIDADES))
    };

    function runCalculations() {
      const category = document.getElementById('calcCategory').value;
      const baseCost = parseFloat(document.getElementById('calcBaseCost').value) || 0;
      const iepsKey = document.getElementById('calcIeps').value;
      const opName = document.getElementById('calcOportunidad').value;
      const isManual = document.getElementById('calcManualToggle').checked;
      const includeIva = document.getElementById('calcIvaToggle').checked;

      const iepsRate = CONFIG.IEPS[iepsKey] || 0;
      const iepsAmt = baseCost * iepsRate;
      const ivaAmt = includeIva ? baseCost * CONFIG.IVA_RATE : 0;
      const totalCost = baseCost + iepsAmt + ivaAmt;

      let marginPct = 0;
      if(isManual) {
        marginPct = parseFloat(document.getElementById('calcManualMargin').value) || 0;
      } else if (opName) {
        // Buscar margen del producto especial seleccionado
        const op = appState.oportunidades[category]?.find(o => o.name === opName);
        marginPct = op ? op.m : 20;
      } else {
        const rules = appState.margins[category];
        const rule = rules.find(r => totalCost < r.max) || rules[rules.length-1];
        marginPct = rule.m;
      }

      const ratio = Math.min(marginPct / 100, 0.99);
      const finalPrice = totalCost / (1 - ratio);
      const profit = finalPrice - totalCost;

      updateMainUI({ finalPrice, profit, marginPct, totalCost, baseCost, iepsAmt, ivaAmt, includeIva });
      updateScales(totalCost, finalPrice);
      saveLocal(); 
    }

    function updateMainUI(d) {
      document.getElementById('resFinalPrice').textContent = fmt$(d.finalPrice);
      document.getElementById('resProfit').textContent = fmt$(d.profit);
      document.getElementById('resMarginPct').textContent = d.marginPct.toFixed(1) + '%';
      document.getElementById('resBaseCost').textContent = fmt$(d.baseCost);
      document.getElementById('resIeps').textContent = fmt$(d.iepsAmt);
      document.getElementById('resIva').textContent = fmt$(d.ivaAmt);
      document.getElementById('resIvaNote').textContent = d.includeIva ? "IVA de compra incluido" : "Sin IVA de compra aplicado";
    }

    function updateScales(cost, basePVP) {
      const container = document.getElementById('scaleTableBody');
      const qtys = document.getElementById('calcScaleQty').value.split(',').map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
      container.innerHTML = '';
      qtys.forEach(q => {
        let disc = q >= 100 ? 8 : (q >= 50 ? 5 : (q >= 10 ? 3 : 0));
        let unitP = basePVP * (1 - disc/100);
        let profit = (unitP - cost) * q;
        let margin = unitP > 0 ? ((unitP - cost) / unitP) * 100 : 0;
        container.innerHTML += `<tr><td class="py-2">${q}</td><td class="font-bold">${fmt$(unitP)}</td><td>${fmt$(unitP * q)}</td><td class="text-green-600">${fmt$(profit)}</td><td class="text-right">${margin.toFixed(1)}%</td></tr>`;
      });
    }

    /* FIREBASE AUTH */
    auth.onAuthStateChanged(user => {
      const dot = document.getElementById('auth-status-dot');
      const text = document.getElementById('auth-status-text');
      const form = document.getElementById('auth-form');
      const actions = document.getElementById('cloud-actions');
      if (user) {
        dot.className = "w-2 h-2 rounded-full bg-green-500";
        text.textContent = user.email;
        form.classList.add('hidden');
        actions.classList.remove('hidden');
      } else {
        dot.className = "w-2 h-2 rounded-full bg-gray-300";
        text.textContent = "Sin conexión";
        form.classList.remove('hidden');
        actions.classList.add('hidden');
      }
    });

    async function handleLogin() {
      const email = document.getElementById('fb-email').value;
      const pass = document.getElementById('fb-pass').value;
      try { await auth.signInWithEmailAndPassword(email, pass); } catch (e) { alert(e.message); }
    }

    async function syncToCloud() {
      if(!auth.currentUser) return;
      try {
        await db.collection('configs').doc('global').set({ data: JSON.stringify(appState), updatedAt: new Date() });
        alert("Sincronizado con éxito.");
      } catch (e) { alert(e.message); }
    }

    async function pullFromCloud() {
      if(!auth.currentUser) return;
      try {
        const doc = await db.collection('configs').doc('global').get();
        if(doc.exists) {
          appState = JSON.parse(doc.data().data);
          saveLocal();
          handleCategoryChange();
          alert("Datos descargados.");
        }
      } catch (e) { alert(e.message); }
    }

    const fmt$ = n => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(n);

    function switchTab(view) {
      document.getElementById('viewCalc').classList.toggle('hidden', view !== 'calc');
      document.getElementById('viewConfig').classList.toggle('hidden', view !== 'config');
      document.getElementById('btnTabCalc').classList.toggle('active', view === 'calc');
      document.getElementById('btnTabConfig').classList.toggle('active', view === 'config');
    }

    function toggleManualMargin() {
      document.getElementById('manualMarginWrap').classList.toggle('hidden');
      runCalculations();
    }

    function handleCategoryChange() {
      const category = document.getElementById('calcCategory').value;
      const opSel = document.getElementById('calcOportunidad');
      opSel.innerHTML = '<option value="">— Ninguno —</option>';
      const items = appState.oportunidades[category] || [];
      items.forEach(o => { opSel.innerHTML += `<option value="${o.name}">${o.name} (${o.m}%)</option>`; });
      runCalculations();
    }

    function saveLocal() { localStorage.setItem(CONFIG.LS_KEY, JSON.stringify(appState)); }

    function resetToDefaults() {
      if(confirm("¿Restablecer todo?")) {
        appState = { margins: JSON.parse(JSON.stringify(CONFIG.DEFAULT_MARGINS)), oportunidades: JSON.parse(JSON.stringify(CONFIG.OPORTUNIDADES)) };
        saveLocal();
        location.reload();
      }
    }

    window.onload = () => {
      const local = localStorage.getItem(CONFIG.LS_KEY);
      if(local) appState = JSON.parse(local);
      
      const iepsSel = document.getElementById('calcIeps');
      iepsSel.innerHTML = `<option value="none">Sin IEPS (0%)</option><option value="azul" style="color:blue">Etiqueta Azul (6%)</option><option value="amarilla" style="color:orange">Etiqueta Amarilla (7%)</option><option value="roja" style="color:red">Etiqueta Roja (9%)</option>`;
      
      lucide.createIcons();
      handleCategoryChange();
    };
  </script>
</body>
</html>
